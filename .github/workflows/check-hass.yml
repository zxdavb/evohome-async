# This workflow tests the evohome-async library against Home Assistant's evohome integration tests
# It clones Home Assistant core, installs this library, and runs the evohome component tests

name: Test with Home Assistant

on:
  schedule:
    - cron: "0 6 * * 1"  # Weekly on Monday at 6am UTC

  push:
    branches: [ "main", "dev" ]
    paths: [
      ".github/workflows/check-lint.yml",
      "pyproject.toml",
      "requirements*.txt",
    ]

  workflow_dispatch:
    inputs:
      ha_repo:
        description: "Home Assistant repository (owner/repo)"
        required: false
        default: "home-assistant/core"
        type: string
      ha_version:
        description: "Home Assistant version/branch to test against"
        required: false
        default: "dev"
        type: string


env:
  HA_REPO: ${{ github.event.inputs.ha_repo || 'home-assistant/core' }}
  HA_VERSION: ${{ github.event.inputs.ha_version || 'dev' }}


jobs:
  get-python-version:
    name: Get Python version from HA
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.get-version.outputs.python-version }}
    steps:
      - name: Check out Home Assistant core
        uses: actions/checkout@v6
        with:
          repository: ${{ env.HA_REPO }}
          ref: ${{ env.HA_VERSION }}
          sparse-checkout: pyproject.toml
          sparse-checkout-cone-mode: false

      - name: Extract Python version from pyproject.toml
        id: get-version
        run: |
          # Extract requires-python, e.g., ">=3.13.2" -> "3.13.2"
          python_version=$(grep -oP 'requires-python\s*=\s*"[><=]*\K[0-9]+\.[0-9]+(\.[0-9]+)?' pyproject.toml)
          echo "python-version=${python_version}" >> $GITHUB_OUTPUT
          echo "Detected Python version: ${python_version}"

  test-with-hass:
    name: Test with HA (Python ${{ needs.get-python-version.outputs.python-version }})
    runs-on: ubuntu-latest
    needs: get-python-version

    steps:
      - name: Check out evohome-async
        uses: actions/checkout@v6
        with:
          path: evohome-async

      - name: Check out Home Assistant core
        uses: actions/checkout@v6
        with:
          repository: ${{ env.HA_REPO }}
          ref: ${{ env.HA_VERSION }}
          path: home-assistant-core

      - name: Set up Python ${{ needs.get-python-version.outputs.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.get-python-version.outputs.python-version }}
          allow-prereleases: true
          check-latest: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Create virtual environment
        working-directory: home-assistant-core
        run: |
          python -m venv venv
          . venv/bin/activate
          pip install "$(grep '^uv' < requirements.txt)"

      - name: Install Home Assistant test dependencies
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          uv pip install -r requirements.txt
          uv pip install -r requirements_test.txt
          # Install Home Assistant in editable mode
          uv pip install -e . --config-settings editable_mode=compat

      - name: Install evohome-async from this repo (replacing PyPI version)
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          # Uninstall the PyPI version and install our local version
          uv pip uninstall evohome-async || true
          uv pip install -e ../evohome-async

      - name: Verify evohome-async installation
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          echo "Installed evohome-async version:"
          python -c "import evohomeasync2; print(f'evohomeasync2 from: {evohomeasync2.__file__}')"
          python -c "import evohomeasync; print(f'evohomeasync from: {evohomeasync.__file__}')"
          # Verify it's our local version (should be in evohome-async directory)
          python -c "import evohomeasync2; assert 'evohome-async' in evohomeasync2.__file__, 'Not using local evohome-async!'"

      - name: Compile English translations
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          python -m script.translations develop --all

      - name: Run Home Assistant evohome tests
        working-directory: home-assistant-core
        env:
          PYTHONDONTWRITEBYTECODE: 1
          PYTEST_ADDOPTS: "--color=yes"
        run: |
          . venv/bin/activate
          python -m pytest \
            -vv \
            --timeout=30 \
            --durations=10 \
            -p no:sugar \
            tests/components/evohome/

      - run: echo "ðŸ This job's status is ${{ job.status }}."
