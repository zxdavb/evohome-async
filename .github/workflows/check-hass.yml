# This workflow tests the evohome-async library against Home Assistant's evohome integration tests
# It clones Home Assistant core, installs this library, and runs the evohome component tests

name: Test with Home Assistant

on:
  schedule:
    - cron: "0 6 * * 1"  # Weekly on Monday at 6am UTC

  workflow_dispatch:
    inputs:
      ha_version:
        description: "Home Assistant version/branch to test against"
        required: false
        default: "dev"
        type: string


env:
  HA_REPO: "home-assistant/core"
  HA_VERSION: ${{ github.event.inputs.ha_version || 'dev' }}


jobs:
  test-with-hass:
    name: Test with HA (${{ matrix.ha-version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13"]
        ha-version: ["dev"]  # Can add specific versions like "2024.12.0"

    steps:
      - name: Check out evohome-async
        uses: actions/checkout@v6
        with:
          path: evohome-async

      - name: Check out Home Assistant core
        uses: actions/checkout@v6
        with:
          repository: ${{ env.HA_REPO }}
          ref: ${{ env.HA_VERSION }}
          path: home-assistant-core

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          check-latest: true

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Create virtual environment
        working-directory: home-assistant-core
        run: |
          python -m venv venv
          . venv/bin/activate
          pip install "$(grep '^uv' < requirements.txt)"

      - name: Install Home Assistant test dependencies
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          uv pip install -r requirements.txt
          uv pip install -r requirements_test.txt
          # Install Home Assistant in editable mode
          uv pip install -e . --config-settings editable_mode=compat

      - name: Install evohome-async from this repo (replacing PyPI version)
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          # Uninstall the PyPI version and install our local version
          uv pip uninstall evohome-async || true
          uv pip install -e ../evohome-async

      - name: Verify evohome-async installation
        working-directory: home-assistant-core
        run: |
          . venv/bin/activate
          echo "Installed evohome-async version:"
          python -c "import evohomeasync2; print(f'evohomeasync2 from: {evohomeasync2.__file__}')"
          python -c "import evohomeasync; print(f'evohomeasync from: {evohomeasync.__file__}')"
          # Verify it's our local version (should be in evohome-async directory)
          python -c "import evohomeasync2; assert 'evohome-async' in evohomeasync2.__file__, 'Not using local evohome-async!'"

      - name: Run Home Assistant evohome tests
        working-directory: home-assistant-core
        env:
          PYTHONDONTWRITEBYTECODE: 1
          PYTEST_ADDOPTS: "--color=yes"
        run: |
          . venv/bin/activate
          python -m pytest \
            -vv \
            --timeout=30 \
            --durations=10 \
            -p no:sugar \
            tests/components/evohome/

      - run: echo "ðŸ This job's status is ${{ job.status }}."
